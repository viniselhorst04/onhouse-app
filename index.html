<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnHouse - Gest√£o de Condom√≠nio</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f5f4f" />

  <style>
    :root{
      --bg:#f2f4f6; --card:#ffffff; --accent:#0f5f4f; --muted:#7b8687; --green:#0b6b58;
      --text:#072021;
    }
    [data-theme="dark"]{
      --bg:#071012; --card:#07171a; --accent:#0f5f4f; --muted:#9aa6a6; --text:#e5f7f2;
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial}
    body{margin:0;background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:flex-start;padding:20px;min-height:100vh}
    .device{width:380px;max-width:calc(100vw - 40px);height:800px;max-height:95vh;background:var(--card);border-radius:18px;box-shadow:0 18px 40px rgba(6,20,28,0.22);overflow:hidden;border:6px solid rgba(15,95,79,0.06)}
    .screen{height:100%;padding:18px;display:flex;flex-direction:column;overflow-y:auto}
    .top{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#cfeee6,#9fd7cc);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;object-fit:cover}
    .user h3{margin:0;font-size:15px}
    .user p{margin:0;color:var(--muted);font-size:12px}
    .clock{color:var(--muted);font-size:12px}
    .cards{display:flex;gap:12px;margin:12px 0}
    .card{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:12px;padding:8px;min-height:120px;cursor:pointer;overflow:hidden}
    .card img{width:100%;height:78px;object-fit:cover;border-radius:8px}
    .card small{display:block;margin-top:8px;color:var(--muted);font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    .tile{background:var(--card);border-radius:12px;padding:14px;display:flex;flex-direction:row;align-items:center;gap:12px;cursor:pointer;box-shadow:0 6px 14px rgba(10,30,30,0.04)}
    .tile .icon{width:44px;height:44;border-radius:10px;background:linear-gradient(180deg,#f2faf7,#e8f3ef);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green)}
    .tile small{color:var(--muted)}
    .nav{margin-top:auto;display:flex;gap:10px;padding-top:10px;align-items:center}
    .nav button{flex:1;padding:10px;border-radius:10px;border:none;background:transparent;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
    .panel-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,20,20,0.45);z-index:999}
    .panel{width:92%;max-width:540px;background:var(--card);border-radius:12px;padding:16px;max-height:88vh;overflow:auto}
    .primary{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eceb;margin-top:8px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .item{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 6px 12px rgba(10,30,30,0.03)}
    .small{font-size:13px;color:var(--muted)}
    .topbar-actions{margin-left:auto;display:flex;gap:8px}
    .toggle{background:transparent;border:1px solid #e6eceb;padding:6px;border-radius:8px;cursor:pointer}
    .brand{font-weight:700;color:var(--accent);font-size:20px}
    .logo-inline{display:flex;align-items:center;gap:10px}
    .empty{color:var(--muted);text-align:center;padding:10px}
    footer.note{font-size:12px;color:var(--muted);text-align:center;padding:8px}

    /* Estilos para o novo cabe√ßalho */
    .app-header {
      position: relative;
      text-align: center;
      padding: 10px 0;
    }
    .app-header .logo {
      height: 50px; /* Altura maior para a logo */
      object-fit: contain;
    }

    /* Estilos para a tela de login */
    .login-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="device" role="application" aria-label="OnHouse app">
    <!-- Tela de Login -->
    <div class="screen" id="login-screen">
      <!-- Novo cabe√ßalho com logo centralizada -->
      <div class="app-header">
        <img src="nova-logo.png" alt="OnHouse Logo" class="logo"/>
        <div class="topbar-actions" style="position:absolute; top: 50%; right: 0; transform: translateY(-50%);">
          <button class="toggle" id="theme-toggle">üåô</button>
          <button class="toggle" id="install-btn" style="display:none">Instalar</button>
        </div>
      </div>

      <div class="login-container">
        <h3 style="margin-bottom: 20px;">Acessar o sistema</h3>
        <label>Usu√°rio</label>
        <input id="login-user" placeholder="admin">
        <label style="margin-top:10px">Senha</label>
        <input id="login-pass" type="password" placeholder="1234">
        <button class="primary" id="login-btn" style="width:100%; margin-top:20px;">Entrar</button>
      </div>
    </div>
    <div class="screen" id="home-screen" style="display:none;">
      <div class="top" style="margin-top:0">
        <div class="avatar" id="avatar"></div>
        <div class="user"><h3 id="username">Tainara</h3><p class="small">Condom√≠nio</p></div>
        <div class="clock small" id="time">--:--</div>
      </div>

      <div class="cards" id="mural-cards"></div>

      <h4 style="margin:10px 0 6px 0">Facilidades</h4>
      <div class="grid">
        <div class="tile" id="t-visitor"><div class="icon">üë•</div><div><strong>Liberar Visitante</strong><div class="small">Registre a libera√ß√£o</div></div></div>
        <div class="tile" id="t-deliveries"><div class="icon">üì¶</div><div><strong>Entregas</strong><div class="small">Registrar chegada</div></div></div>
        <div class="tile" id="t-reservations"><div class="icon">üìÖ</div><div><strong>Reservas</strong><div class="small">Sal√£o, Quadra...</div></div></div>
        <div class="tile" id="t-announce"><div class="icon">üì¢</div><div><strong>Nova Notifica√ß√£o</strong><div class="small">Enviar para os moradores</div></div></div>
        <div class="tile" id="t-users"><div class="icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div><div><strong>Gerenciar Usu√°rios</strong><div class="small">Adicionar ou remover</div></div></div>
      </div>

      <div style="margin-top:14px">
        <h4>√öltimas notifica√ß√µes</h4>
        <div id="mural-list" class="list"></div>
      </div>

      <div class="nav" style="margin-top:12px">
        <button id="nav-home">üè†<small>Home</small></button>
        <button id="nav-mural">üì∞<small>Mural</small></button>
        <button id="nav-profile">üë§<small>Perfil</small></button>
        <button id="btn-new" style="background:var(--accent);color:#fff;border-radius:10px;padding:10px;border:none;cursor:pointer">‚ûï</button>
      </div>

      <footer class="note">Prot√≥tipo PWA ‚Ä¢ Dados salvos localmente</footer>
    </div>
  </div>

  <!-- overlay panel -->
  <div class="panel-overlay" id="overlay">
    <div class="panel" id="panel-content"></div>
  </div>

  <script>
    // --- Global State & Constants ---
      // IMPORTANTE: Substitua 'SEU_IP_AQUI' pelo endere√ßo IPv4 do seu computador (ex: 192.168.0.15)
    const API_URL = 'https://onhouse-app-backend.onrender.com/api';
    let appData = { announcements: [], deliveries: [], reservations: [] };
    const overlay = document.getElementById('overlay');
    const panel = document.getElementById('panel-content');

    // --- Toast Notification ---
    function showToast(message, type = 'success', duration = 2000) {
        const icon = type === 'success' ? '‚úÖ' : '‚ùå';
        const messageHTML = `
            <div class="message-dialog">
                <div style="font-size: 40px; margin-bottom: 10px;">${icon}</div>
                <p>${message}</p>
            </div>
        `;
        openPanel(messageHTML);

        // Fecha o pop-up automaticamente ap√≥s a dura√ß√£o especificada
        setTimeout(() => {
            // Verifica se o painel ainda est√° mostrando nossa mensagem antes de fechar
            if (panel.innerHTML === messageHTML) {
                closePanel();
            }
        }, duration);
    }

    // --- Custom Confirmation Dialog ---
    function showConfirm(message, onConfirm) {
        const confirmHTML = `
            <div class="confirm-dialog">
                <p>${message}</p>
                <div style="display:flex; justify-content:center; gap:12px;">
                    <button class="primary" id="confirm-btn">Confirmar</button>
                    <button class="toggle" onclick="closePanel()">Cancelar</button>
                </div>
            </div>
        `;
        openPanel(confirmHTML);
        document.getElementById('confirm-btn').onclick = () => {
            onConfirm();
        };
    }

    // --- API Helper ---
    async function fetchWithAuth(endpoint, options = {}) {
        const token = sessionStorage.getItem('authToken');
        if (!token) {
            throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
        }
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers,
        };
        const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
        if (!response.ok) {
            const errorResult = await response.json().catch(() => ({ message: 'Ocorreu um erro desconhecido.' }));
            throw new Error(errorResult.message || `A requisi√ß√£o falhou com o status ${response.status}`);
        }
        // Handle empty responses for DELETE, etc.
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            return response.json();
        }
        return { success: true };
    }

    // --- Auth & Data Loading ---
    async function handleLogin() {
        const loginBtn = document.getElementById('login-btn');
        const userKey = document.getElementById('login-user').value.toLowerCase();
        const pass = document.getElementById('login-pass').value;

        loginBtn.disabled = true;
        loginBtn.textContent = 'Entrando...';

        try {
            const response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: userKey, password: pass }),
            });
            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'Usu√°rio ou senha inv√°lidos!');
            }
            const result = await response.json();
            sessionStorage.setItem('authToken', result.token);
            sessionStorage.setItem('loggedInUser', JSON.stringify(result.user));
            await checkLoginState();
        } catch (error) {
            console.error('Erro ao tentar fazer login:', error);
            showToast(error.message, 'error');
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'Entrar';
        }
    }

    function handleLogout() {
        sessionStorage.removeItem('loggedInUser');
        sessionStorage.removeItem('authToken');
        location.reload();
    }

    async function loadInitialData(currentUser) {
        try {
            const [announcements, deliveries, reservations] = await Promise.all([
                fetchWithAuth('/announcements'),
                fetchWithAuth('/deliveries'),
                fetchWithAuth('/reservations'),
            ]);
            appData.announcements = announcements;
            appData.deliveries = deliveries;
            appData.reservations = reservations;
            console.log('Dados iniciais carregados do servidor.');
            renderUIForUser(currentUser);
        } catch (error) {
            console.error('Falha ao carregar dados do servidor:', error);
            showToast(error.message, 'error');
            if (error.message.includes('Sess√£o expirada')) {
                handleLogout();
            }
        }
    }

    async function checkLoginState() {
        const loggedInUserJSON = sessionStorage.getItem('loggedInUser');
        if (loggedInUserJSON) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            const currentUser = JSON.parse(loggedInUserJSON);
            await loadInitialData(currentUser);
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('home-screen').style.display = 'none';
        }
    }

    // --- UI Rendering ---
    function renderUIForUser(user) {
        if (!user) { handleLogout(); return; }
        renderUserProfile(user);
        renderCards();
        renderMuralList();

        const isAdmin = user.role === 'admin';
        document.getElementById('t-announce').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('t-users').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('btn-new').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('t-visitor').style.display = user.role === 'condomino' ? 'flex' : 'none';
    }

    function renderUserProfile(profile) {
        document.getElementById('username').innerText = profile.name;
        const avatarEl = document.getElementById('avatar');
        if (profile.avatar) {
            avatarEl.innerHTML = `<img src="${profile.avatar}" class="avatar" alt="Foto de perfil" style="width:100%;height:100%">`;
        } else {
            avatarEl.innerHTML = '';
            avatarEl.innerText = profile.initials;
        }
    }

    function renderCards() {
        const container = document.getElementById('mural-cards');
        container.innerHTML = '';
        const anns = appData.announcements.filter(a => a.title !== 'Libera√ß√£o de Visitante').slice(0, 3);
        anns.forEach(a => {
            const c = document.createElement('div');
            c.className = 'card';
            c.innerHTML = `<img src='${a.img || `https://picsum.photos/400/180?random=${a.id}`}' alt='${a.title}'/><small>${a.title}</small>`;
            c.onclick = () => openAnnouncement(a.id);
            container.appendChild(c);
        });
    }

    function renderMuralList() {
        const list = document.getElementById('mural-list');
        list.innerHTML = '';
        const anns = appData.announcements.slice(0, 5);
        if (!anns.length) {
            list.innerHTML = '<div class="empty">Nenhuma notifica√ß√£o</div>';
            return;
        }
        anns.forEach(a => {
            const it = document.createElement('div');
            it.className = 'item';
            it.innerHTML = `<strong>${a.title}</strong><div class='small'>${new Date(a.ts).toLocaleString()}</div>`;
            it.onclick = () => openAnnouncement(a.id);
            list.appendChild(it);
        });
    }

    // --- Panel Logic ---
    function openPanel(html) {
        overlay.style.display = 'flex';
        panel.innerHTML = html;
        overlay.onclick = (e) => { if (e.target === overlay) closePanel(); };
    }

    function closePanel() {
        overlay.style.display = 'none';
        panel.innerHTML = '';
        overlay.onclick = null;
    }

    // --- Announcements ---
    function showAnnounceForm() {
        openPanel(`<h2>Nova notifica√ß√£o</h2>
          <label>T√≠tulo</label><input id='a_title' placeholder='Assunto'>
          <label>Texto</label><textarea id='a_text' rows=4 placeholder='Mensagem para o condom√≠nio'></textarea>
          <label>Imagem (URL, opcional)</label><input id='a_img' placeholder='https://...'>
          <div style='display:flex;gap:8px;margin-top:12px'><button class='primary' id='pub'>Publicar</button><button class='toggle' id='canc'>Cancelar</button></div>`);
        document.getElementById('canc').onclick = closePanel;
        document.getElementById('pub').onclick = handleSaveAnnouncement;
    }

    async function handleSaveAnnouncement() {
        const title = document.getElementById('a_title').value.trim();
        const text = document.getElementById('a_text').value.trim();
        const img = document.getElementById('a_img').value.trim();
        if (!title || !text) { showToast('Preencha t√≠tulo e texto', 'error'); return; }

        try {
            const newAnnouncement = await fetchWithAuth('/announcements', { method: 'POST', body: JSON.stringify({ title, text, img }) });
            appData.announcements.unshift(newAnnouncement);
            renderCards();
            renderMuralList();
            closePanel();
            showToast('Notifica√ß√£o publicada com sucesso!');
        } catch (error) {
            console.error('Erro ao salvar notifica√ß√£o:', error);
            showToast(error.message, 'error');
        }
    }

    function openAnnouncement(id) {
        const a = appData.announcements.find(x => x.id == id);
        if (!a) { alert('N√£o encontrado'); return; }

        const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const deleteButtonHTML = currentUser && currentUser.role === 'admin'
            ? `<button class='toggle' onclick='handleDeleteAnnouncement(${a.id})'>Remover</button>`
            : '';

        openPanel(`<h2>${a.title}</h2><div class='small'>${new Date(a.ts).toLocaleString()}</div><img src='${a.img || `https://picsum.photos/600/200?random=${a.id}`}' style='width:100%;margin-top:8px;border-radius:8px'/><p style='margin-top:8px'>${a.text}</p><div style='display:flex;gap:8px;margin-top:8px'><button class='primary' onclick='closePanel()'>Fechar</button>${deleteButtonHTML}</div>`);
    }

    async function handleDeleteAnnouncement(id) {
        const deleteAction = async () => {
            try {
                await fetchWithAuth(`/announcements/${id}`, { method: 'DELETE' });
                appData.announcements = appData.announcements.filter(a => a.id !== id);
                renderCards();
                renderMuralList();
                closePanel();
                showToast('Notifica√ß√£o removida com sucesso!');
            } catch (error) {
                console.error('Erro ao remover notifica√ß√£o:', error);
                showToast(error.message, 'error');
            }
        };

        showConfirm('Tem certeza que deseja remover esta notifica√ß√£o?', deleteAction);
    }

    // --- Deliveries ---
    function openPanelDeliveries() {
        const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const renderDeliveryItem = (d) => `<div class='item'><strong>${d.owner}</strong><div class='small'>${new Date(d.ts).toLocaleString()}</div><p>${d.info}</p></div>`;

        const adminFormHTML = currentUser.role === 'admin' ? `
          <hr><h3>Registrar entrega</h3>
          <input id='d_owner' placeholder='Nome do destinat√°rio'><input id='d_info' placeholder='Descri√ß√£o / C√≥digo'>
          <div style='display:flex;gap:8px;margin-top:8px'><button class='primary' id='addD'>Registrar</button></div>`
            : `<div style='margin-top:12px;'><button class='toggle' onclick='closePanel()'>Fechar</button></div>`;

        openPanel(`<h2>Entregas</h2>
          <div id='deliveries_list'>${appData.deliveries.length ? appData.deliveries.map(renderDeliveryItem).join('') : '<div class="empty">Nenhuma entrega registrada</div>'}</div>
          ${adminFormHTML}`);

        if (currentUser.role === 'admin') {
            document.getElementById('addD').onclick = handleAddDelivery;
        }
    }

    async function handleAddDelivery() {
        const owner = document.getElementById('d_owner').value.trim();
        const info = document.getElementById('d_info').value.trim();
        if (!owner || !info) { showToast('Preencha todos os campos', 'error'); return; }

        try {
            const newDelivery = await fetchWithAuth('/deliveries', { method: 'POST', body: JSON.stringify({ owner, info }) });
            appData.deliveries.unshift(newDelivery);
            openPanelDeliveries();
            showToast('Entrega registrada com sucesso!');
        } catch (error) {
            console.error('Erro ao registrar entrega:', error);
            showToast(error.message, 'error');
        }
    }

    // --- Reservations ---
    function openPanelReservations() {
        const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const renderReservationItem = (r) => `<div class='item'><strong>${r.place}</strong><div class='small'>${new Date(r.date).toLocaleString()}</div><p>Reservado por: ${r.owner}</p></div>`;

        openPanel(`<h2>Reservas</h2><div id='res_list'>${appData.reservations.length ? appData.reservations.map(renderReservationItem).join('') : '<div class="empty">Nenhuma reserva</div>'}</div><hr><h3>Nova reserva</h3><input id='r_place' placeholder='Local (ex: Sal√£o de festas)'><input id='r_owner' value='${currentUser.name}' placeholder='Nome'><input id='r_date' type='datetime-local'><div style='display:flex;gap:8px;margin-top:8px'><button class='primary' id='addR'>Reservar</button><button class='toggle' onclick='closePanel()'>Fechar</button></div>`);
        document.getElementById('addR').onclick = handleAddReservation;
    }

    async function handleAddReservation() {
        const place = document.getElementById('r_place').value.trim();
        const owner = document.getElementById('r_owner').value.trim();
        const date = document.getElementById('r_date').value;
        if (!place || !owner || !date) { showToast('Preencha todos os campos', 'error'); return; }

        try {
            const newReservation = await fetchWithAuth('/reservations', { method: 'POST', body: JSON.stringify({ place, owner, date }) });
            appData.reservations.push(newReservation);
            appData.reservations.sort((a, b) => new Date(a.date) - new Date(b.date));
            openPanelReservations();
            showToast('Reserva criada com sucesso!');
        } catch (error) {
            console.error('Erro ao criar reserva:', error);
            showToast(error.message, 'error');
        }
    }

    // --- Visitor ---
    function openPanelVisitor() {
        openPanel(`<h2>Liberar Visitante</h2><input id='v_name' placeholder='Nome do visitante'><input id='v_plate' placeholder='Placa / Identifica√ß√£o (opcional)'><input id='v_unit' placeholder='Unidade visitada'><div style='display:flex;gap:8px;margin-top:8px'><button class='primary' id='relV'>Liberar</button><button class='toggle' onclick='closePanel()'>Fechar</button></div><div class='small' style='margin-top:12px'>A libera√ß√£o gera uma notifica√ß√£o para o condom√≠nio.</div>`);
        document.getElementById('relV').onclick = handleReleaseVisitor;
    }

    async function handleReleaseVisitor() {
        const name = document.getElementById('v_name').value.trim();
        const unit = document.getElementById('v_unit').value.trim();
        if (!name || !unit) { showToast('Preencha nome e unidade', 'error'); return; }

        try {
            const newAnnouncement = await fetchWithAuth('/visitor-releases', { method: 'POST', body: JSON.stringify({ name, unit }) });
            appData.announcements.unshift(newAnnouncement);
            renderCards();
            renderMuralList();
            closePanel();
            showToast('Visitante liberado e notifica√ß√£o enviada!');
        } catch (error) {
            console.error('Erro ao liberar visitante:', error);
            showToast(error.message, 'error');
        }
    }

    // --- Users (Admin) ---
    async function openPanelUsers() {
        try {
            const users = await fetchWithAuth('/users');
            const renderUserItem = (u) => `<div class='item'><strong>${u.name}</strong><div class='small'>@${u.username} - ${u.role}</div></div>`;

            openPanel(`<h2>Gerenciar Usu√°rios</h2>
                <div id='users_list'>${users.length ? users.map(renderUserItem).join('') : '<div class="empty">Nenhum usu√°rio encontrado.</div>'}</div>
                <hr><h3>Novo Usu√°rio</h3>
                <input id='u_name' placeholder='Nome completo'>
                <input id='u_username' placeholder='Nome de usu√°rio (para login)'>
                <input id='u_password' type='password' placeholder='Senha tempor√°ria'>
                <select id='u_role' style='width:100%; padding:10px; border-radius:8px; border:1px solid #e6eceb; margin-top:8px;'>
                    <option value='condomino'>Morador (condomino)</option>
                    <option value='admin'>Administrador</option>
                </select>
                <div style='display:flex;gap:8px;margin-top:8px'>
                    <button class='primary' id='addUserBtn'>Criar Usu√°rio</button>
                    <button class='toggle' onclick='closePanel()'>Fechar</button>
                </div>
            `);

            document.getElementById('addUserBtn').onclick = handleCreateUser;
        } catch (error) {
            console.error('Erro ao buscar usu√°rios:', error);
            showToast(error.message, 'error');
            closePanel();
        }
    }

    async function handleCreateUser() {
        const name = document.getElementById('u_name').value.trim();
        const username = document.getElementById('u_username').value.trim().toLowerCase();
        const password = document.getElementById('u_password').value.trim();
        const role = document.getElementById('u_role').value;

        if (!name || !username || !password) { showToast('Preencha todos os campos para criar o usu√°rio.', 'error'); return; }

        try {
            await fetchWithAuth('/users', { method: 'POST', body: JSON.stringify({ name, username, password, role }) });
            showToast('Usu√°rio criado com sucesso!');
            openPanelUsers(); // Recarrega o painel para mostrar o novo usu√°rio
        } catch (error) {
            console.error('Erro ao criar usu√°rio:', error);
            showToast(error.message, 'error');
        }
    }

    // --- Full Mural & Profile ---
    function openMuralFull() {
        openPanel(`<h2>Mural</h2><div class='list'>${appData.announcements.map(a => `<div class='item'><strong>${a.title}</strong><div class='small'>${new Date(a.ts).toLocaleString()}</div><p>${a.text}</p><div style='display:flex;gap:8px'><button class='primary' onclick='openAnnouncement(${a.id})'>Abrir</button></div></div>`).join('')}</div><div style='margin-top:12px'><button class='toggle' onclick='closePanel()'>Fechar</button></div>`);
    }

    function openProfile() {
        const profile = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const avatarHTML = profile.avatar
            ? `<img src="${profile.avatar}" class="avatar" style="width:60px;height:60px" alt="Foto de perfil">`
            : `<div class="avatar" style="width:60px;height:60px;font-size:24px">${profile.initials}</div>`;

        openPanel(`<h2>Perfil</h2>
          <div class='item' style="display:flex; align-items:center; gap: 12px;">${avatarHTML}<div><strong>${profile.name}</strong><div class='small'>${profile.role}</div></div></div>
          <div style='margin-top:12px; display:flex; gap: 8px;'><button class='toggle' onclick='handleLogout()'>Sair</button><button class='toggle' onclick='closePanel()'>Fechar</button></div>
          <p class="small" style="margin-top: 12px;">Funcionalidades de alterar nome/foto ser√£o implementadas.</p>`);
    }

    // --- Initialization ---
    function initialize() {
        // Event Listeners
        document.getElementById('login-btn').onclick = handleLogin;
        document.getElementById('t-announce').onclick = showAnnounceForm;
        document.getElementById('btn-new').onclick = showAnnounceForm;
        document.getElementById('t-deliveries').onclick = openPanelDeliveries;
        document.getElementById('t-reservations').onclick = openPanelReservations;
        document.getElementById('t-visitor').onclick = openPanelVisitor;
        document.getElementById('t-users').onclick = openPanelUsers;
        document.getElementById('nav-mural').onclick = openMuralFull;
        document.getElementById('nav-profile').onclick = openProfile;
        document.getElementById('nav-home').onclick = () => { if (overlay.style.display !== 'none') closePanel(); };

        // Clock
        const timeEl = document.getElementById('time');
        const nowTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        timeEl.innerText = nowTime();
        setInterval(() => timeEl.innerText = nowTime(), 60000);

        // Theme
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('oh_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        themeToggle.onclick = () => {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            themeToggle.innerText = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('oh_theme', newTheme);
        };

        // PWA Install
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            deferredPrompt = null;
            installBtn.style.display = 'none';
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(() => console.log('SW registrado')).catch(e => console.warn('SW falhou', e));
        }

        // Initial Check
        checkLoginState();
    }

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
